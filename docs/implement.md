# 実装（TDD） - 蔵書管理アプリ

このドキュメントは、テスト駆動開発（TDD）のアプローチを用いて実装を進める際の指針を記述する。

## TDDサイクル

すべての機能実装は、以下のサイクルに従う。

1.  **Red:** 失敗するテストを書く。このテストは、これから実装する機能の仕様をコードで表現したものである。
2.  **Green:** テストが通る最小限のコードを書く。この段階では、コードの綺麗さよりも、まずテストをパスさせることを優先する。
3.  **Refactor:** テストが通る状態を維持しながら、コードをクリーンにする（重複の排除、命名の改善など）。

## Backend実装のTDD手順例 (書籍登録機能)

1.  **Red:**
    - `test_main.py` を作成。
    - 書籍データ（JSON）を `POST /api/books/` に送信し、ステータスコード `201` (Created) と、レスポンスボディに登録されたデータが含まれることを検証するテストケース `test_create_book` を書く。
    - この時点ではエンドポイントが存在しないため、テストは失敗する。

2.  **Green:**
    - `main.py` に `POST /api/books/` エンドポイントを最小限の形で実装する。
    - リクエストボディを受け取り、それをそのまま返すだけでも良い。
    - `crud.py` に `create_book` 関数を作成し、データベースにデータを保存するロジックを実装する。
    - `main.py` から `crud.create_book` を呼び出すように修正し、テストが通ることを確認する。

3.  **Refactor:**
    - `main.py` や `crud.py` のコードを見直し、変数名が適切か、重複したコードはないかなどを確認し、リファクタリング（コードの清掃）を行う。
    - リファクタリング後、再度テストを実行し、すべてパスすることを確認する。

## 外部サービス連携機能のTDD手順例 (価格取得機能)

1.  **Red:**
    - `tests/test_services.py` を作成。
    - 外部サイト（Book-Off Online）から価格を取得する非同期関数 `scrape_bookoff_online_price` をテストする `test_scrape_bookoff_online_price` を書く。
    - 既知のISBNと期待される価格を複数パターン用意し、テストが失敗することを確認する。

2.  **Green:**
    - `app/services/market_price_scraper.py` に `scrape_bookoff_online_price` 関数を実装する。
    - `httpx` でWebページを取得し、`BeautifulSoup` でHTMLを解析して、テストケースで指定された価格が取得できる最小限のロジックを記述する。
    - テストが通ることを確認する。

3.  **Refactor:**
    - スクレイピングのロジックを改善する（価格が見つからない場合の処理、CSSセレクタの堅牢化、エラーハンドリングの追加など）。
    - リファクタリング後もテストがすべてパスすることを維持する。

---

このアプローチを `doc/tasks.md` の各タスクに適用して開発を進める。
